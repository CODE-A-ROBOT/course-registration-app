<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kurswahl</title>
  <style>
    .course-selection-hidden {
      display: none;
    }
  </style>
</head>
<body>

  <h1>Kurswahl </h1>

  <form id="courseForm">
    <h2>Prüfungsfächer</h2>

    <h3>Schule</h3>
<!-- Add a text input field for school -->
<div class="course-selection">
  <label for="schoolInput">Schule (z.B. 04Y01):</label>
  <br/>

  <input type="text" id="schoolInput" name="schoolInput" oninput="filterOptions('schoolInput', 'column1Select')">
  <br/>
  <button type="button" onclick="selectEnteredSchool()">Enter</button>
</div>

<!-- Existing dropdown for school -->
<div class="course-selection-hidden">
  <label for="schoolSelect">Schule:</label>
  <select id="schoolSelect" name="schoolSelect" onchange="filterOptions('schoolSelect', 'column1Select')"></select>
</div>

<script>
  // Function to select entered school
  function selectEnteredSchool() {
    const schoolInput = document.getElementById('schoolInput');
    const schoolSelect = document.getElementById('schoolSelect');

    // Set the value of the dropdown to the entered value
    schoolSelect.value = schoolInput.value;

    // Trigger change event to update dependent dropdowns
    const event = new Event('change');
    schoolSelect.dispatchEvent(event);
  }
</script>


    <h3>Leistungskursfächer</h3>
    <div class="course-selection">
      <label for="column1Select">Leistungskursfach 1:</label>
      <select id="column1Select" name="column1Select" onchange="filterOptions('column1Select', 'column2Select')"></select>
    </div>

    <div class="course-selection">
      <label for="column2Select">Leistungskursfach 2:</label>
      <select id="column2Select" name="column2Select" onchange="filterOptions('column2Select', 'column3Select')"></select>
    </div>

    <h3>Prüfungsfächer</h3>
    <div class="course-selection">
      <label for="column3Select">Prüfungsfach 3:</label>
      <select id="column3Select" name="column3Select" onchange="filterOptions('column3Select', 'column4Select')"></select>
    </div>

    <div class="course-selection">
      <label for="column4Select">Prüfungsfach 4:</label>
      <select id="column4Select" name="column4Select" onchange="filterOptions('column4Select', 'column5Select')"></select>
    </div>
<!--
    <h3>5. PK</h3>
    <div class="course-selection">
      <label for="column5Select">Referenzfach:</label>
      <select id="column5Select" name="column5Select" onchange="filterOptions('column5Select', 'column6Select')"></select>
    </div>
  -->

    <h3>5. PK</h3>

    <div class="course-selection">
      <label for="column5Select">Referenzfach:</label>
      <select id="column5Select" name="column5Select" onchange="handlePKSelection('column5Select', 'column6Select')"></select>
    </div>


    <h3>weitere Grundkurse mit Belegverpflichtung</h3>
    <div class="course-selection">
      <label for="column6Select">De:</label>
      <select id="column6Select" name="column6Select" onchange="filterOptions('column6Select', 'column7Select')"></select>
    </div>

    <div class="course-selection">
      <label for="column7Select">FS</label>
      <select id="column7Select" name="column7Select" onchange="filterOptions('column7Select', 'column8Select')"></select>
    </div>

    <div class="course-selection">
      <label for="column8Select">Ge:</label>
      <select id="column8Select" name="column8Select" onchange="filterOptions('column8Select', 'column9Select')"></select>
    </div>

    <div class="course-selection">
      <label for="column9Select">PW</label>
      <select id="column9Select" name="column9Select" onchange="filterOptions('column9Select', 'column10Select')"></select>
    </div>

    <div class="course-selection">
      <label for="column10Select">Ma</label>
      <select id="column10Select" name="column10Select"></select>
    </div>

    <br>
    <button type="button" onclick="submitForm()">Submit</button>
  </form>

  <script>
    let data; // Declare the data variable
    let subjectsMap;

    // New function to fetch and parse subjects.json
    async function fetchSubjects() {
      try {
        const response = await fetch('subjects.json');
        if (!response.ok) {
          throw new Error(`Failed to fetch subjects.json. Status: ${response.status}`);
        }
        subjectsMap = new Map((await response.json()).map(item => [item.label, item.subjects]));

      } catch (error) {
        console.error(error);
      }
    }


// Updated fetchCourses function
async function fetchCourses() {
  try {
    await fetchSubjects(); // Fetch subjects first

    const response = await fetch('data.json');
    if (!response.ok) {
      throw new Error(`Failed to fetch data.json. Status: ${response.status}`);
    }
    data = await response.json();


    // Fetch and populate the School select
    fetchAndPopulateSelect('schoolSelect', data);
  } catch (error) {
    console.error(error);
  }
}

// Updated fetchAndPopulateSelect function
function fetchAndPopulateSelect(selectId, data) {
  const select = document.getElementById(selectId);

  // Clear existing options
  select.innerHTML = '';

  // Create the default option for the school dropdown
  if (selectId === 'schoolSelect') {
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.text = 'Select...';
    select.appendChild(defaultOption);
  }

  const uniqueValues = [...new Set(data.map(item => item[selectId]))];
  uniqueValues.forEach(value => {
    /*
    if (value === '*') {
      console.log("value is *");
      const origs = subjectsMap.get('*');
      // Create options for subjects dropdown
      origs.split(',').forEach(subject => {
        const option = document.createElement('option');
        option.value = subject.trim();
        option.text = subject.trim();
        select.appendChild(option);
      });

    } else {
      const option = document.createElement('option');
      option.value = value;
      option.text = value;
      select.appendChild(option);
    }
    */
    const option = document.createElement('option');
    option.value = value;
    option.text = value;
    select.appendChild(option);
  });
  // Create and append subjects dropdowns for all values in subjectsMap
  subjectsMap.forEach((subjects, value) => {
    const subjectsDropdown = createSubjectsDropdown(value, subjects, selectId, select.parentNode);
    if (subjectsDropdown) {
      //console.log('select.parentNode:', select.parentNode);
      select.parentNode.appendChild(subjectsDropdown);
    }
  });

  // Set up an event listener to hide/show subjects dropdowns based on the selected value
  select.addEventListener('change', () => {
    subjectsMap.forEach((_, value) => {
      const subjectsDropdownId = `${selectId}-${value}-subjects-dropdown`;
      const subjectsDropdown = document.getElementById(subjectsDropdownId);

      if (subjectsDropdown) {
        subjectsDropdown.style.display = select.value === value ? 'inline-block' : 'none';
        //console.log('Selected Value:', subjectsDropdownId, subjectsDropdown.style.display);
      }
    });
  });
}
function createSubjectsDropdown(value, subjects, selectId, parentNode) {
  const subjectsDropdownId = `${selectId}-${value}-subjects-dropdown`;
  //console.log('createSubjectsDropdown selectId: ' + selectId + ' value: ' + value);

  const subjectsDropdown = document.createElement('select');
  subjectsDropdown.classList.add('subjects-dropdown');
  subjectsDropdown.id = subjectsDropdownId;
  subjectsDropdown.style.display = 'none'; // Initially hide the subjects dropdown

  if (subjects === undefined) {
    return null;
  }
  subjects.split(',').forEach(subject => {
    const option = document.createElement('option');
    option.value = subject.trim();
    option.text = subject.trim();

    subjectsDropdown.appendChild(option);
  });

  // Add subject dropdowns to the subjects dropdown if the subject is again in subjectsMap
  subjects.split(',').forEach(subject => {
    const subjectValue = subject.trim();
    //console.log('createSubjectsDropdown subjectValue: ' + subjectValue);
    if (subjectsMap.has(subjectValue)) {
      //console.log('subjectsMap.has(subjectValue): ' + subjectValue);

      const nestedSubjectsDropdown = createSubjectsDropdown(subjectValue, subjectsMap.get(subjectValue), subjectsDropdownId, parentNode);
      if (nestedSubjectsDropdown) {
        //console.log('subjectsDropdown:', subjectsDropdown);
        //console.log('parentNode:', parentNode);

        parentNode.appendChild(nestedSubjectsDropdown);
      }
    }
  });

  // Set up an event listener to hide/show subjects dropdowns based on the selected value
  subjectsDropdown.addEventListener('change', () => {
    subjectsMap.forEach((_, value) => {
      const nestedSubjectsDropdownId = `${selectId}-${value}-subjects-nesteddropdown`;
      const nestedSubjectsDropdown = document.getElementById(nestedSubjectsDropdownId);

      if (nestedSubjectsDropdown) {
        //nestedSubjectsDropdown.style.display = select.value === value ? 'inline-block' : 'none';
        //console.log('Selected Value:', subjectsDropdown.value);
      }
    });
  });

  return subjectsDropdown;
}
// Updated createSubjectsDropdown function
function createSubjectsDropdownPK(value, subjects, selectId, parentNode) {
  const subjectsDropdownId = `${selectId}-${value}-subjects-dropdown`;
  //console.log('createSubjectsDropdown selectId: ' + selectId + ' value: ' + value);

  const subjectsDropdown = document.createElement('select');
  subjectsDropdown.classList.add('subjects-dropdown');
  subjectsDropdown.id = subjectsDropdownId;
  subjectsDropdown.style.display = 'none'; // Initially hide the subjects dropdown

  if (subjects === undefined) {
    return null;
  }
  subjects.split(',').forEach(subject => {
    const option = document.createElement('option');
    option.value = subject.trim();
    option.text = subject.trim();

    subjectsDropdown.appendChild(option);
  });

  // Add subject dropdowns to the subjects dropdown if the subject is again in subjectsMap
  subjects.split(',').forEach(subject => {
    const subjectValue = subject.trim();
    //console.log('createSubjectsDropdown subjectValue: ' + subjectValue);
    if (subjectsMap.has(subjectValue)) {
      //console.log('subjectsMap.has(subjectValue): ' + subjectValue);

      const nestedSubjectsDropdown = createSubjectsDropdown(subjectValue, subjectsMap.get(subjectValue), subjectsDropdownId, parentNode);
      if (nestedSubjectsDropdown) {
        //console.log('subjectsDropdown:', subjectsDropdown);
        //console.log('parentNode:', parentNode);

        parentNode.appendChild(nestedSubjectsDropdown);
      }
    }
  });

  // Set up an event listener to hide/show subjects dropdowns based on the selected value
  subjectsDropdown.addEventListener('change', () => {
    subjectsMap.forEach((_, value) => {
      const nestedSubjectsDropdownId = `${selectId}-${value}-subjects-nesteddropdown`;
      const nestedSubjectsDropdown = document.getElementById(nestedSubjectsDropdownId);

      if (nestedSubjectsDropdown) {
        nestedSubjectsDropdown.style.display = select.value === value ? 'inline-block' : 'none';
        //console.log('Selected Value:', subjectsDropdown.value);
      }
    });
  });

  return subjectsDropdown;
}



    // Fetch courses and subjects when the page loads
    document.addEventListener('DOMContentLoaded', fetchCourses);

    // Additional function to submit the form
    function submitForm() {
      // Add your logic to handle the selected values (e.g., send them to the server)
      // Access the selected values using document.getElementById('selectId').value
      console.log('Form submitted!');
    }

    // Function to filter options and update dropdowns
    async function filterOptions(sourceSelectId, targetSelectId) {
      const sourceSelect = document.getElementById(sourceSelectId);
      const targetSelect = document.getElementById(targetSelectId);

      // Get the selected value from the source select
      const selectedValue = sourceSelect.value;

      // Filter the data based on the selected value
      const filteredData = data.filter(item => item[sourceSelectId] === selectedValue);

      // Repopulate the target select with the first available option
      fetchAndPopulateSelect(targetSelectId, filteredData);

      // Trigger change event for the target select to continue the cascade
      const event = new Event('change');
      targetSelect.dispatchEvent(event);
    }
  </script>
<!-- ... (Your existing HTML code) -->

<!-- ... (Your existing HTML code) -->

<script>
  // Function to handle PK selection
  function handlePKSelection(sourceSelectId, targetSelectId) {
    const sourceSelect = document.getElementById(sourceSelectId);
    const targetSelect = document.getElementById(targetSelectId);

    // Get the selected value from the source select
    const selectedValue = sourceSelect.value;

    // Clear existing options
    targetSelect.innerHTML = '';

    if (selectedValue === '*') {
      // Show subjects dropdown
      fetchAndPopulateSelect(targetSelectId, data);
      console.log('handleAdditionalSubjects: sourceSelectId: ' + sourceSelectId +  ' targetSelectId: ' + targetSelectId);

      handleAdditionalSubjects(sourceSelectId, targetSelectId, targetSelect, selectedValue);
    } else {
      // Hide subjects dropdown
      targetSelect.style.display = 'none';
    }
  }

  // Function to handle additional subjects dropdowns
  function handleAdditionalSubjects(sourceSelectId, targetSelectId, targetSelect, selectedValue) {
    // Check if the selected subject has additional subjects
    if (subjectsMap && subjectsMap.has(selectedValue)) {
      const additionalSubjects = subjectsMap.get(selectedValue);

      // Show the subjects dropdown
      targetSelect.style.display = 'inline-block';

      // Check if additionalSubjects is a string before attempting to split it
      if (typeof additionalSubjects === 'string') {
        console.log('additionalSubjects: ' + additionalSubjects);
        const additionalSubjectsArray = additionalSubjects.split(',');
        console.log('additionalSubjectsArray: ' + additionalSubjectsArray);
        console.log('additionalSubjectsArray[0]: ' + additionalSubjectsArray[0]);
        console.log('additionalSubjectsArray[1]: ' + additionalSubjectsArray[1]);

        // Check if there are additional subjects
        if (additionalSubjectsArray.length > 1) {
          
          // Populate the subjects dropdown
          additionalSubjectsArray.forEach(subject => {
            const option = document.createElement('option');
            option.value = subject.trim();
            option.text = subject.trim();
            targetSelect.appendChild(option);
          });

          // Create and append additional subjects dropdowns for all values in subjectsMap
          additionalSubjectsArray.forEach(subject => {
            const additionalSubjectsDropdown = createSubjectsDropdownPK(subject.trim(), subjectsMap.get(subject.trim()), sourceSelectId, targetSelectId);
            console.log("additionalSubjectsDropdown: " + additionalSubjectsDropdown);
            console.log("targetSelect.parentNode: " + targetSelect.parentNode);
            if (additionalSubjectsDropdown) {
              targetSelect.parentNode.appendChild(additionalSubjectsDropdown);
              additionalSubjectsDropdown.style.display = 'inline-block';

            }

          });
        }
      }
    }
  }

  // ... (Your existing functions and code)
</script>

<!-- ... (Your existing HTML code) -->


<!-- ... (Your existing HTML code) -->

</body>
</html>
